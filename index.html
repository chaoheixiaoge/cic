<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>æŠ¥ä»· & ææ ¸ æˆåŠŸç‡å¯è§†åŒ–</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body { font-family: sans-serif; margin: 20px; background: #f9f9f9; }
    h2 { margin-top: 40px; }
    svg { background: white; border: 1px solid #ccc; margin-bottom: 20px; }
    pre { background: #fff; padding: 1em; white-space: pre-wrap; border: 1px solid #ddd; }
    label, select { font-size: 16px; margin-right: 10px; }
  </style>

  <style>
    .tooltip {
      position: absolute;
      padding: 8px;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 4px;
      pointer-events: none;
      font-size: 14px;
      display: none;
      color: #333;
      box-shadow: 2px 2px 10px rgba(0,0,0,0.1);
      line-height: 1.4em;
    }
  </style>

</head>
<body>
  <h1>ğŸ“Š æŠ¥ä»· & ææ ¸ æˆåŠŸç‡è¶‹åŠ¿é¢æ¿</h1>

  <section>
    <h2>ğŸ“ˆ æˆåŠŸç‡è¶‹åŠ¿å›¾ï¼ˆæ¯æ—¥ï¼‰</h2>
    <svg id="line-chart" width="800" height="400"></svg>
  </section>

  <section>
    <h2>ğŸ“Š æˆåŠŸç‡å¯¹æ¯”å›¾ï¼ˆæœ¬å‘¨ vs ä¸Šå‘¨ï¼‰</h2>
    <svg id="bar-chart" width="800" height="400"></svg>
  </section>
  <section>
    <h2>æ¯æ—¥ä¿è´¹ & ä¿å•æ•°å›¾åƒå±•ç¤º</h2>
    <label for="agent-select">é€‰æ‹©ä»£ç†äººï¼š</label>
    <select id="agent-select" onchange="updateAgentImage()">
      <option value="èš‚èšä¿ä¿é™©ä»£ç†æœ‰é™å…¬å¸">èš‚èšä¿ä¿é™©ä»£ç†æœ‰é™å…¬å¸</option>
      <option value="å¾®ä¿ä¿é™©ä»£ç†æœ‰é™å…¬å¸">å¾®ä¿ä¿é™©ä»£ç†æœ‰é™å…¬å¸</option>
    </select>

    <label for="img-start">å¼€å§‹æ—¥æœŸï¼š</label>
    <input type="date" id="img-start" value="2025-06-01">
    <label for="img-end">ç»“æŸæ—¥æœŸï¼š</label>
    <input type="date" id="img-end" value="2025-07-01">
    <button onclick="updateAgentImage()">åŠ è½½å›¾åƒ</button>

    <br><br>
    <img id="agent-image" src="" alt="ä¿è´¹ä¸ä¿å•æ•°å›¾åƒ" width="800" style="border:1px solid #ccc;">
  </section>
  <section>
    <h2>ğŸ“Š è½¦é™©é¡¹ç›®æ—¥æŠ¥ï¼ˆæˆªè‡³2025-07-15ï¼‰</h2>
    <img src="assets/car_report_summary.png" alt="è½¦é™©é¡¹ç›®æ—¥æŠ¥" style="max-width: 1000px; border:1px solid #ccc;">
  </section>



  <section>
    <h2>ğŸ“„ æ—¥æŠ¥ / å‘¨æŠ¥ æŸ¥çœ‹</h2>
    <label for="report-date">é€‰æ‹©æ—¥æœŸï¼š</label>
    <input type="date" id="report-date" max="2025-07-07" value="2025-07-07">
    <button onclick="loadReports()">åŠ è½½æŠ¥å‘Š</button>

    <h3>ğŸ“„ æ—¥æŠ¥</h3>
    <pre id="daily-report">è¯·é€‰æ‹©æ—¥æœŸåŠ è½½æ—¥æŠ¥</pre>

    <h3>ğŸ“„ å‘¨æŠ¥</h3>
    <pre id="weekly-report">è¯·é€‰æ‹©æ—¥æœŸåŠ è½½å‘¨æŠ¥</pre>
  </section>

  <script>
    const parseDate = d3.timeParse("%Y-%m-%d");
    const formatDate = d3.timeFormat("%Y-%m-%d");

    function loadReports() {
      const date = document.getElementById("report-date").value;
      document.getElementById("daily-report").textContent = "åŠ è½½ä¸­...";
      document.getElementById("weekly-report").textContent = "åŠ è½½ä¸­...";

      fetch(`æ—¥æŠ¥è¾“å‡º/æ—¥æŠ¥_${date}.txt`)
        .then(res => res.ok ? res.text() : "æ—¥æŠ¥æœªæ‰¾åˆ°")
        .then(text => document.getElementById("daily-report").textContent = text);

      const monday = d3.timeMonday(parseDate(date));
      const sunday = new Date(monday.getTime() + 6 * 24 * 60 * 60 * 1000);
      const weekFile = `å‘¨æŠ¥è¾“å‡º/å‘¨æŠ¥_${formatDate(monday)}_${formatDate(sunday)}.txt`;

      fetch(weekFile)
        .then(res => res.ok ? res.text() : "å‘¨æŠ¥æœªæ‰¾åˆ°")
        .then(text => document.getElementById("weekly-report").textContent = text);
    }

    // ç”»æŠ˜çº¿å›¾
    d3.json("trend_data.json").then(data => {
      const svg = d3.select("#line-chart");
      const margin = {top: 30, right: 60, bottom: 40, left: 60};
      const width = +svg.attr("width") - margin.left - margin.right;
      const height = +svg.attr("height") - margin.top - margin.bottom;
      const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

      const x = d3.scaleTime().range([0, width]);
      const y = d3.scaleLinear().range([height, 0]);

      const color = d3.scaleOrdinal()
        .domain(["æŠ¥ä»·æˆåŠŸç‡", "ææ ¸æˆåŠŸç‡", "è½¬åŒ–ç‡"])
        .range(["steelblue", "darkorange", "green"]);

      const line = d3.line()
        .x(d => x(parseDate(d.æ—¥æœŸ)))
        .y(d => y(d.å€¼));

      const keys = ["æŠ¥ä»·æˆåŠŸç‡", "ææ ¸æˆåŠŸç‡", "è½¬åŒ–ç‡"];
      const all = keys.flatMap(key => data.map(d => ({ æ—¥æœŸ: d.æ—¥æœŸ, æŒ‡æ ‡: key, å€¼: d[key] })));

      x.domain(d3.extent(all, d => parseDate(d.æ—¥æœŸ)));
      y.domain([0, 1]);

      g.append("g")
        .attr("transform", `translate(0,${height})`)
        .call(d3.axisBottom(x).ticks(7).tickFormat(d3.timeFormat("%m-%d")));

      g.append("g")
        .call(d3.axisLeft(y).ticks(10).tickFormat(d3.format(".0%")));

      keys.forEach(key => {
        const filtered = all.filter(d => d.æŒ‡æ ‡ === key);
        g.append("path")
          .datum(filtered)
          .attr("fill", "none")
          .attr("stroke", color(key))
          .attr("stroke-width", 2)
          .attr("d", line);
      });

      keys.forEach((key, i) => {
        g.append("text")
          .attr("x", width - 80)
          .attr("y", i * 20)
          .attr("fill", color(key))
          .text(key);
      });
    });

    // æ¡å½¢å›¾
    d3.json("bar_compare.json").then(data => {
      const svg = d3.select("#bar-chart");
      const margin = {top: 30, right: 30, bottom: 60, left: 60};
      const width = +svg.attr("width") - margin.left - margin.right;
      const height = +svg.attr("height") - margin.top - margin.bottom;
      const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

      const subgroups = ["æœ¬å‘¨", "ä¸Šå‘¨"];
      const groups = ["æŠ¥ä»·æˆåŠŸç‡", "ææ ¸æˆåŠŸç‡", "è½¬åŒ–ç‡"];

      const x = d3.scaleBand().domain(groups).range([0, width]).padding([0.2]);
      const xSub = d3.scaleBand().domain(subgroups).range([0, x.bandwidth()]).padding([0.05]);
      const y = d3.scaleLinear().domain([0, 1]).range([height, 0]);

      const color = d3.scaleOrdinal().domain(subgroups).range(["#377eb8", "#ff7f00"]);

      g.append("g")
        .attr("transform", `translate(0,${height})`)
        .call(d3.axisBottom(x));

      g.append("g")
        .call(d3.axisLeft(y).tickFormat(d3.format(".0%")));

      g.append("g")
        .selectAll("g")
        .data(groups)
        .join("g")
        .attr("transform", d => `translate(${x(d)},0)`)
        .selectAll("rect")
        .data(group => subgroups.map(sub => ({key: group, subgroup: sub, value: data[sub][group]})))
        .join("rect")
        .attr("x", d => xSub(d.subgroup))
        .attr("y", d => y(d.value))
        .attr("width", xSub.bandwidth())
        .attr("height", d => height - y(d.value))
        .attr("fill", d => color(d.subgroup));

      g.append("text")
        .attr("x", width - 120)
        .attr("y", -10)
        .attr("fill", "#333")
        .text("å•ä½ï¼šç™¾åˆ†æ¯”");
    });
  
  function updateAgentImage() {
    const agent = document.getElementById("agent-select").value;
    const start = document.getElementById("img-start").value;
    const end = document.getElementById("img-end").value;
    if (!agent || !start || !end) return;
    const filename = `${agent}_${start}_${end}.png`.replaceAll("/", "_");
    const filepath = `output/${filename}`;
    document.getElementById("agent-image").src = filepath;
  }
</script>
<div id="maturity_chart" style="margin-top:40px;">
  <h2>ğŸ“ˆ ç´¯è®¡æ»¡æœŸèµ”ä»˜ç‡è¶‹åŠ¿å›¾</h2>

  <div>
    <label><strong>é€‰æ‹©ä»£ç†äººï¼š</strong></label>
    <button onclick="loadMaturityChart('èš‚èšä¿ä¿é™©ä»£ç†æœ‰é™å…¬å¸')">èš‚èšä¿</button>
    <button onclick="loadMaturityChart('å¾®ä¿ä¿é™©ä»£ç†æœ‰é™å…¬å¸')">å¾®ä¿</button>
    <span id="current-agent" style="margin-left: 20px; font-weight: bold;">å½“å‰ä»£ç†äººï¼šèš‚èšä¿ä¿é™©ä»£ç†æœ‰é™å…¬å¸</span>
  </div>

  <svg width="900" height="400"></svg>
</div>

<style>
  .tooltip {
    position: absolute;
    padding: 8px;
    background: #fff;
    border: 1px solid #ccc;
    border-radius: 4px;
    pointer-events: none;
    font-size: 14px;
    display: none;
    color: #333;
    box-shadow: 2px 2px 10px rgba(0,0,0,0.1);
    line-height: 1.4em;
  }
</style>

  <style>
    .tooltip {
      position: absolute;
      padding: 8px;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 4px;
      pointer-events: none;
      font-size: 14px;
      display: none;
      color: #333;
      box-shadow: 2px 2px 10px rgba(0,0,0,0.1);
      line-height: 1.4em;
    }
  </style>


<script>
  const svg = d3.select("#maturity_chart svg");
  const margin = {top: 40, right: 60, bottom: 40, left: 60};
  const width = +svg.attr("width") - margin.left - margin.right;
  const height = +svg.attr("height") - margin.top - margin.bottom;
  const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);
  const tooltip = d3.select("body").append("div").attr("class", "tooltip");
  
  // å°†ä»£ç†äººä¸ç¼–ç å»ºç«‹æ˜ å°„å…³ç³»
  const agentCodeMap = {
    "èš‚èšä¿ä¿é™©ä»£ç†æœ‰é™å…¬å¸": "2233001203000010",
    "å¾®ä¿ä¿é™©ä»£ç†æœ‰é™å…¬å¸": "2237131203000039"
  };
  
  function loadMaturityChart(agentName) {
    const code = agentCodeMap[agentName];
    if (!code) {
      alert("æœªçŸ¥ä»£ç†äººï¼š" + agentName);
      return;
    }
    const file = `maturity_trend_${code}.json`;
  
    document.getElementById("current-agent").textContent = `å½“å‰ä»£ç†äººï¼š${agentName}`;
    g.selectAll("*").remove();
  
    d3.json(file).then(function(data) {
      data.forEach(d => {
        d.date = new Date(d.date);
        d.maturity_premium = +d.maturity_premium;
        d.settled_claim = +d.settled_claim;
        d.unsettled_claim = +d.unsettled_claim;
        d.total_claim = d.settled_claim + d.unsettled_claim;
        d.loss_ratio = +d.cumulative_loss_ratio;
      });
  
      const x = d3.scaleTime().domain(d3.extent(data, d => d.date)).range([0, width]);
      const yLeft = d3.scaleLinear()
        .domain([0, d3.max(data, d => Math.max(d.maturity_premium, d.total_claim)) * 1.1])
        .range([height, 0]);
      const yRight = d3.scaleLinear()
        .domain([0, d3.max(data, d => d.loss_ratio) * 1.1])
        .range([height, 0]);
  
      const line1 = d3.line().x(d => x(d.date)).y(d => yLeft(d.maturity_premium));
      const line2 = d3.line().x(d => x(d.date)).y(d => yLeft(d.total_claim));
      const line3 = d3.line().x(d => x(d.date)).y(d => yRight(d.loss_ratio));
  
      g.append("g").call(d3.axisLeft(yLeft));
      g.append("g").attr("transform", `translate(${width},0)`).call(d3.axisRight(yRight));
      g.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(x));
  
      g.append("path").datum(data).attr("fill", "none").attr("stroke", "steelblue")
       .attr("stroke-width", 2).attr("d", line1);
      g.append("path").datum(data).attr("fill", "none").attr("stroke", "orange")
       .attr("stroke-width", 2).attr("d", line2);
      g.append("path").datum(data).attr("fill", "none").attr("stroke", "green")
       .style("stroke-dasharray", "5,5").attr("stroke-width", 2).attr("d", line3);
  // å›¾ä¾‹
const legendData = [
  { label: "æ»¡æœŸä¿è´¹ï¼ˆä¸‡å…ƒï¼‰", color: "steelblue", dashed: false },
  { label: "èµ”æ¬¾é‡‘é¢ï¼ˆå·²å†³+æœªå†³ï¼‰", color: "orange", dashed: false },
  { label: "æ»¡æœŸèµ”ä»˜ç‡ï¼ˆ%ï¼‰", color: "green", dashed: true }
];

const legend = svg.append("g")
  .attr("class", "legend")
  .attr("transform", `translate(${margin.left}, ${margin.top - 20})`);

legend.selectAll("g")
  .data(legendData)
  .enter()
  .append("g")
  .attr("transform", (d, i) => `translate(${i * 260}, 0)`)
  .each(function(d) {
    const g = d3.select(this);
    g.append("line")
      .attr("x1", 0).attr("x2", 20).attr("y1", 0).attr("y2", 0)
      .attr("stroke", d.color).attr("stroke-width", 3)
      .style("stroke-dasharray", d.dashed ? "5,5" : "none");
    
    g.append("text")
      .attr("x", 25).attr("y", 5)
      .text(d.label)
      .style("font-size", "14px")
      .attr("alignment-baseline", "middle");
  });
      const bisectDate = d3.bisector(d => d.date).left;
      svg.on("mousemove", function(event) {
        const [xPos] = d3.pointer(event);
        const x0 = x.invert(xPos - margin.left);
        const i = bisectDate(data, x0, 1);
        const d0 = data[i - 1], d1 = data[i];
        const d = (!d1 || (x0 - d0.date < d1.date - x0)) ? d0 : d1;
  
        tooltip.html(`
          <strong>${d3.timeFormat("%Y-%m-%d")(d.date)}</strong><br>
          æ»¡æœŸä¿è´¹ï¼š${d.maturity_premium.toFixed(1)} ä¸‡å…ƒ<br>
          èµ”æ¬¾é‡‘é¢ï¼š${d.total_claim.toFixed(1)} ä¸‡å…ƒ<br>
          èµ”ä»˜ç‡ï¼š${(d.loss_ratio * 100).toFixed(1)}%
        `)
        .style("left", (event.pageX + 20) + "px")
        .style("top", (event.pageY - 30) + "px")
        .style("display", "block");
      });
  
      svg.on("mouseleave", () => tooltip.style("display", "none"));
    }).catch(err => {
      alert("åŠ è½½æ•°æ®å¤±è´¥ï¼š" + file);
      console.error(err);
    });
  }
  
  // é»˜è®¤åŠ è½½èš‚èšä¿
  loadMaturityChart("èš‚èšä¿ä¿é™©ä»£ç†æœ‰é™å…¬å¸");
  </script>
